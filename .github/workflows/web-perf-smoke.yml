name: Web Performance Smoke

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL to test (e.g. https://example.com)"
        required: false
        default: ""
      max_cold_ms:
        description: "Cold-path threshold in ms"
        required: false
        default: "1500"
      max_warm_ms:
        description: "Warm-path threshold in ms"
        required: false
        default: "500"
  schedule:
    - cron: "0 15 * * *"

jobs:
  perf-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Resolve base URL
        id: resolve-url
        run: |
          if [ -n "${{ github.event.inputs.base_url }}" ]; then
            BASE_URL="${{ github.event.inputs.base_url }}"
          elif [ -n "${{ secrets.WEB_PERF_BASE_URL }}" ]; then
            BASE_URL="${{ secrets.WEB_PERF_BASE_URL }}"
          else
            echo "No base URL provided. Set workflow input base_url or secret WEB_PERF_BASE_URL."
            exit 1
          fi
          echo "base_url=${BASE_URL}" >> "$GITHUB_OUTPUT"

      - name: Prewarm caches
        env:
          BASE_URL: ${{ steps.resolve-url.outputs.base_url }}
          PERF_PREWARM_TIMEOUT_MS: "12000"
        run: npm run perf:prewarm

      - name: Run performance gate
        env:
          BASE_URL: ${{ steps.resolve-url.outputs.base_url }}
          PERF_AUDIT_OUTPUT: /tmp/web_perf_audit.md
          PERF_MAX_COLD_MS: ${{ github.event.inputs.max_cold_ms || '1500' }}
          PERF_MAX_WARM_MS: ${{ github.event.inputs.max_warm_ms || '500' }}
          PERF_REQUIRE_2XX: "true"
          PERF_AUDIT_TIMEOUT_MS: "12000"
        run: npm run perf:audit

      - name: Publish summary
        if: always()
        run: |
          if [ -f /tmp/web_perf_audit.md ]; then
            cat /tmp/web_perf_audit.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No performance report generated." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-perf-audit
          path: /tmp/web_perf_audit.md
          if-no-files-found: ignore
